version: 2

before:
  hooks:
    - go mod tidy
    - sh -c 'ls .release-extra/*.vsix >/dev/null'

gomod:
  proxy: true
  env:
    - GOPROXY=https://proxy.golang.org,direct
    - GOSUMDB=sum.golang.org
    - GOPRIVATE=github.com/kpumuk/thrift-weaver
  mod: mod

builds:
  - id: thriftfmt
    main: ./cmd/thriftfmt
    binary: thriftfmt
    flags: &go_build_flags
      - -buildvcs=false
    env: &cgo_cross_env
      - CGO_ENABLED=1
      - >-
        {{- if eq .Os "linux" }}
          {{- if eq .Arch "amd64" }}CC=x86_64-linux-gnu-gcc{{- end }}
          {{- if eq .Arch "arm64" }}CC=aarch64-linux-gnu-gcc{{- end }}
        {{- end }}
        {{- if eq .Os "darwin" }}
          {{- if eq .Arch "amd64" }}CC=o64-clang{{- end }}
          {{- if eq .Arch "arm64" }}CC=oa64-clang{{- end }}
        {{- end }}
        {{- if eq .Os "windows" }}
          {{- if eq .Arch "amd64" }}CC=x86_64-w64-mingw32-gcc{{- end }}
          {{- if eq .Arch "arm64" }}CC=aarch64-w64-mingw32-gcc{{- end }}
        {{- end }}
      - >-
        {{- if eq .Os "linux" }}
          {{- if eq .Arch "amd64" }}CXX=x86_64-linux-gnu-g++{{- end }}
          {{- if eq .Arch "arm64" }}CXX=aarch64-linux-gnu-g++{{- end }}
        {{- end }}
        {{- if eq .Os "darwin" }}
          {{- if eq .Arch "amd64" }}CXX=o64-clang++{{- end }}
          {{- if eq .Arch "arm64" }}CXX=oa64-clang++{{- end }}
        {{- end }}
        {{- if eq .Os "windows" }}
          {{- if eq .Arch "amd64" }}CXX=x86_64-w64-mingw32-g++{{- end }}
          {{- if eq .Arch "arm64" }}CXX=aarch64-w64-mingw32-g++{{- end }}
        {{- end }}
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      # Temporarily disabled: goreleaser-cross v1.26.0 image used in CI lacks a Windows ARM64 MinGW toolchain.
      - goos: windows
        goarch: arm64
  - id: thriftls
    main: ./cmd/thriftls
    binary: thriftls
    flags: *go_build_flags
    env: *cgo_cross_env
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      # Temporarily disabled: goreleaser-cross v1.26.0 image used in CI lacks a Windows ARM64 MinGW toolchain.
      - goos: windows
        goarch: arm64

archives:
  - id: thriftfmt
    ids:
      - thriftfmt
    name_template: >-
      {{ .Binary }}_
      {{- .Version }}-
      {{- .Os }}_
      {{- .Arch }}
    format_overrides:
      - goos: windows
        formats: [zip]
  - id: thriftls
    ids:
      - thriftls
    name_template: >-
      {{ .Binary }}_
      {{- .Version }}-
      {{- .Os }}_
      {{- .Arch }}
    format_overrides:
      - goos: windows
        formats: [zip]

checksum:
  name_template: "checksums.txt"
  extra_files: &release_extra_files
    - glob: .release-extra/*.vsix
    - glob: docs/release.md
      name_template: UNSIGNED-BETA-RELEASE-POLICY.md

release:
  draft: true
  replace_existing_draft: true
  replace_existing_artifacts: true
  extra_files: *release_extra_files

snapshot:
  version_template: "{{ incpatch .Version }}-next"

changelog:
  use: github
  filters:
    exclude:
      - "^docs:"
      - '.*\[docs?\]$'
      - "^test:"
      - '.*\[tests?\]$'
      - "^lint:"
      - '.*\[lint\]$'
      - "^chore"
      - '.*\[chore\]$'
      - "merge conflict"
      - Merge pull request
      - Merge remote-tracking branch
      - Merge branch
      - go mod tidy

# Notes:
# - Release workflow uses `goreleaser-cross` to cross-compile cgo/tree-sitter targets in a single Linux job.
# - `thriftls` managed-install manifest / VS Code release metadata are generated by repo scripts after GoReleaser creates archives/checksums.
# - Windows arm64 publication is enabled but remains best-effort until runtime validation is fully automated.
