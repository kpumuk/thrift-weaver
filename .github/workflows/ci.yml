name: ci

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  lint-and-test:
    name: lint-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up mise
        uses: jdx/mise-action@v3

      - name: Install pinned tools
        run: mise install

      - name: Run repo CI checks (Go + VS Code extension)
        run: |
          mise run ci
          git diff --exit-code

  build-smoke:
    name: build-smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: ./go.mod

      - name: Build CLI binaries (smoke)
        run: go build ./cmd/...

  race-lsp:
    name: race-lsp
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up mise
        uses: jdx/mise-action@v3

      - name: Install pinned tools
        run: mise install

      - name: Run LSP race tests
        run: mise run test-race-lsp

  package-vscode-extension-smoke:
    name: package-vscode-extension-smoke
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Build VS Code extension package (smoke)
        run: |
          npm --prefix editors/vscode ci
          npm --prefix editors/vscode version 0.0.0-ci --no-git-tag-version
          npm --prefix editors/vscode run compile
          npm --prefix editors/vscode run package -- --no-yarn --allow-missing-repository

      - name: Upload VSIX artifact for release smoke
        uses: actions/upload-artifact@v6
        with:
          name: vscode-vsix-smoke
          path: editors/vscode/*.vsix
          if-no-files-found: error

  vscode-extension-smoke:
    name: vscode-extension-smoke (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: ./go.mod

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Run VS Code extension smoke tests
        run: |
          npm --prefix editors/vscode ci
          npm --prefix editors/vscode run compile
          npm --prefix editors/vscode run test:extension-smoke

  release-artifacts-smoke:
    name: release-artifacts-smoke
    runs-on: ubuntu-latest
    needs: package-vscode-extension-smoke
    container:
      image: ghcr.io/goreleaser/goreleaser-cross:v1.26.0
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download VSIX artifact
        uses: actions/download-artifact@v7
        with:
          name: vscode-vsix-smoke
          path: .release-extra

      - name: Run GoReleaser release path (snapshot smoke)
        run: goreleaser release --snapshot --clean

      - name: Generate checksums + release metadata (smoke)
        run: |
          snapshot_version="$(sed -n 's/.*"version":"\([^"]*\)".*/\1/p' dist/metadata.json | head -n1)"
          if [ -z "$snapshot_version" ]; then
            echo "failed to read snapshot version from dist/metadata.json" >&2
            exit 1
          fi

          go run ./scripts/generate-release-manifest \
            --version "$snapshot_version" \
            --repo kpumuk/thrift-weaver \
            --tag "v$snapshot_version" \
            --artifacts-dir dist \
            --checksums dist/checksums.txt \
            --output dist/thriftls-manifest.json

          vsix_path="$(ls .release-extra/*.vsix | head -n1)"
          go run ./scripts/generate-vscode-release-metadata \
            --vsix "$vsix_path" \
            --checksums dist/checksums.txt \
            --tool-version "$snapshot_version" \
            --extension-version 0.0.0-ci \
            --output dist/vscode-release-metadata.json

          test -s dist/checksums.txt
          test -s dist/thriftls-manifest.json
          test -s dist/vscode-release-metadata.json

  parser-generation-drift:
    name: parser-generation-drift
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up mise
        uses: jdx/mise-action@v3

      - name: Install pinned tools
        run: mise install

      - name: Regenerate tree-sitter parser
        run: scripts/generate-tree-sitter.sh

      - name: Check generated parser drift
        run: |
          git diff --exit-code -- grammar/tree-sitter-thrift/src

  thrift-oracle-compat:
    name: thrift-oracle-compat
    if: ${{ vars.THRIFT_ORACLE_VERSION_PREFIX != '' }}
    runs-on: ubuntu-22.04
    env:
      THRIFT_ORACLE_REQUIRED: "1"
      THRIFT_ORACLE_VERSION_PREFIX: ${{ vars.THRIFT_ORACLE_VERSION_PREFIX }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up mise
        uses: jdx/mise-action@v3

      - name: Install pinned tools
        run: mise install

      - name: Install thrift compiler (oracle)
        run: |
          sudo apt-get update
          sudo apt-get install -y thrift-compiler
          thrift -version

      - name: Run official thrift oracle compatibility test
        run: mise exec golang -- go test ./internal/format -run '^TestFormattedOutputParsesWithOfficialThriftOracle$' -count=1
