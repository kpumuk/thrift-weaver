[tools]
golang = "1.26.0"
node = "22.14.0"
tree-sitter = "0.26.5"
golangci-lint = "2.10.1"
lefthook = "2.1.1"
goreleaser = "2.14.0"

[tasks.ci]
description = "Run formatter, linters, and tests (Go + VS Code extension)"
depends = ["format", "lint", "test", "vscode-ci"]

[tasks.format]
description = "Format Go code with golangci-lint formatters"
run = "golangci-lint fmt"
alias = "fmt"

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run ./cmd/... ./grammar/... ./internal/... ./scripts/..."

[tasks.test]
description = "Run Go tests"
run = "go test ./cmd/... ./grammar/... ./internal/... ./scripts/..."

[tasks.test-race-lsp]
description = "Run race detector for LSP/document-store packages"
run = "go test -race ./internal/lsp ./cmd/thriftls"

[tasks.vscode-install]
description = "Install VS Code extension dev dependencies (lockfile)"
run = "npm --prefix editors/vscode ci"

[tasks.vscode-compile]
description = "Compile VS Code extension TypeScript"
depends = ["vscode-install"]
run = "npm --prefix editors/vscode run compile"

[tasks.vscode-test]
description = "Run VS Code extension tests (typecheck + syntax smoke)"
depends = ["vscode-install"]
run = "npm --prefix editors/vscode run test"

[tasks.vscode-ci]
description = "Run VS Code extension compile + tests"
depends = ["vscode-compile", "vscode-test"]

[tasks.vscode-install-extension]
description = "Compile and install VS Code extension"
depends = ["vscode-compile"]
run = "npm --prefix editors/vscode run package && code --install-extension editors/vscode/thrift-weaver-vscode-0.0.1.vsix --force"

[tasks.grammars]
description = "Regenerate tree-sitter parser and wasm grammar artifacts"
run = "scripts/generate-tree-sitter.sh && scripts/generate-tree-sitter-wasm.sh"

[tasks.grammars-drift]
description = "Validate parser and wasm grammar artifacts are up to date"
run = "scripts/generate-tree-sitter.sh && scripts/generate-tree-sitter-wasm.sh && scripts/verify-tree-sitter-wasm.sh && git diff --exit-code -- grammar/tree-sitter-thrift/src internal/grammars/thrift/thrift.wasm internal/grammars/thrift/thrift.wasm.sha256"
